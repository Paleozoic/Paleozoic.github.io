---
title: 分布式一致性算法：二段提交和三段提交
date: 2017-05-31 10:54:53
categories: [分布式,一致性算法]
tags: [分布式一致性算法,二段提交,三段提交,分布式事务]
---
<Excerpt in index | 首页摘要>
分布式一致性算法：二段提交和三段提交，常用于分布式系统的事务操作。<!-- more -->
<The rest of contents | 余下全文>
# 概念定义
- 协调者：事务管理器
- 参与者：资源管理器

# 二段提交2PC(Two-phase commit)
## 过程
- 准备阶段：协调者询问参与者开启事务，参与者写入undo log和redo log，并告知协调者已就绪
- 事务提交阶段：协调者收到所有参与者的就绪确认，则向参与者发送提交事务请求。参与者commit事务并释放资源。并告知协调者事务已提交。

## 异常分析
- 如果协调者和参与者同时挂掉，而参与者执行了rollback/commit操作，却来不及返回给协调者。此时即使选举了新的协调者，也不知道宕掉的参与者的事务状态。
新的协调者也就无法告知其他参与者执行commit还是rollback了。
- 如果参与者异常，协调者会告知所有参与者回滚事务，执行rollback。参与者如果恢复，对于未提交的事务也采取rollback操作。
- 如果协调者异常，选出新的协调者后，参与者将事务状态告知新的协调者，然后协调者做出响应处理。

## 缺点
- 协调者和参与者同时宕机，事务状态不可预知。（产生脏数据）
- 资源阻塞：准备阶段事务已经start，各个参与者锁定所有的相关资源，等待事务结束后才释放资源。

# 三段提交3PC(Three-phase commit)
## 过程

## 异常分析

## 缺点

# 引用
[深入理解分布式系统的2PC和3PC](https://coderknock.com/blog/2016/12/18/PC.html)
