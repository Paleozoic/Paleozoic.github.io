---
title: 分布式一致性算法：二段提交和三段提交
date: 2017-05-31 10:54:53
categories: [分布式,一致性算法]
tags: [分布式一致性算法,二段提交,三段提交,分布式事务]
---
<Excerpt in index | 首页摘要>
分布式一致性算法：二段提交和三段提交，常用于分布式系统的事务操作。<!-- more -->
<The rest of contents | 余下全文>
# 概念定义
- 协调者：coordinator,事务管理器，每个节点（参与者）都知道自己的事务状态，但无法知道自己之外的事务状态。协调者的作用是管理所有参与者的事务状态。决定整个事务的commit/rollback。
- 参与者：participant,资源管理器，真正控制锁定事务资源的节点。可以理解为提供RPC服务的节点。

# 前提
- 节点可恢复：宕机后节点必须是能恢复提供正常服务的。
- 日志持久化：节点写入的undo log和redo log是被认为持久化且不可改变的。

# 二段提交2PC(Two-phase commit)
## 过程
- 准备阶段：协调者询问参与者开启事务，参与者写入undo log和redo log，并告知协调者已就绪
- 事务提交阶段：协调者收到所有参与者的就绪确认，则向参与者发送提交事务请求。参与者commit事务并释放资源。并告知协调者事务已提交。
![2PC](/resources/img/distributed_systems/2PC.png)

## 异常分析
- 协调者和参与者同时挂掉：而参与者执行了rollback/commit操作，却来不及返回给协调者。此时即使选举了新的协调者，也不知道宕掉的参与者的事务状态。
新的协调者也就无法告知其他参与者执行commit还是rollback了。
- 参与者异常：协调者会告知所有参与者回滚事务，执行rollback。参与者如果恢复，对于未提交的事务也采取rollback操作。
- 协调者异常：选出新的协调者后，参与者将事务状态告知新的协调者，然后协调者做出响应处理。
![2PC_ExceptionAnalysis](/resources/img/distributed_systems/2PC_ExceptionAnalysis.png)

## 缺点
- 脏数据问题：协调者和参与者同时宕机，事务状态不可预知。（产生脏数据）
- 资源阻塞问题：准备阶段事务已经start，各个参与者锁定所有的相关资源，等待事务结束后才释放资源。如果此时参与者宕机，协调者无法收到参与者的ack消息，其它参与者的事务资源都不会释放，出现阻塞。（当然这里协调者和参与者之间可以有Lease机制，超时后自动释放事务资源，缓解性能问题）
- 单点问题：所有参与者的事务已开启并锁定了资源后，协调者异常，参与者无法与协调者通信，引发资源阻塞。参与者没有Lease机制，会一直阻塞。

# 三段提交3PC(Three-phase commit)
## 过程
- canCommit：协调者询问参与者是否可以开启事务？（此时事务没有打开，资源没有被锁定阻塞）
- preCommit：参与者确认可以提交，协调者请求参与者开启事务，写入redo log和undo log。
- doCommit：协调者收到参与者preCommit的确认后，发送请求让参与者提交事务。

## 异常分析
主要异常分析集中在第二阶段preCommit，因为从第二阶段开始，才开启了事务。
- 协调者和参与者同时挂掉：新的协调者被选举出来，没人知道宕机的参与者的事务状态。参与者恢复后，假设其事务状态是：
    * commit：如果宕机参与者事务已提交，其它参与者可能的preCommit或者commit（指协调者收到了参与者的）
    * rollback：
- 参与者异常：协调者会告知所有参与者回滚事务，执行rollback。参与者如果恢复，对于未提交的事务也采取rollback操作。
- 协调者异常：选出新的协调者后，参与者将事务状态告知新的协调者，然后协调者做出响应处理。

## 解决了2PC的问题和代价
3PC将2PC的第一阶段拆分为canCommit和preCommit两个阶段。
- 资源阻塞问题：canCommit阶段不开启事务，只是询问状态。降低阻塞的可能性。代价：多了一次RPC请求
- 单点问题：参与者引入Lease机制，协调者宕机，参与者与其通信超时后，释放锁定的事务资源。代价：

## 缺点


如果参与者提交事务后，ack信息协调者没收到，然后其他参与者回滚了消息，此时应当如何处理？

# 引用
[深入理解分布式系统的2PC和3PC](https://coderknock.com/blog/2016/12/18/PC.html)
